```{r}

library(tidyverse)
library(tidymodels)
library(lubridate)
library(GGally)

theme_set(theme_minimal())
test_data <- read_csv(here::here("data/test_data.csv"))

```
```{r}

colnames(test_data)
```
There are nine features, plus a key and our target. I'm thinking a tree-based model might be the most appropriate option.

What is the breakdown of our label? 

```{r}

test_data %>%
    count(target)

```
Some preprocessing.

```{r}

test_data <- test_data %>%
    mutate_at(vars(ideo, employ, target), as.factor) %>%
    mutate(
      age = year(as.period(interval(ymd(paste0(birth_year, "0101")), today())))
    )

```

About a 50/50 split between our two groups. I don't think we'll have to worry about class imbalance. I'll split up the data between a training, holdout, and test date. 

```{r}
test <- test_data %>%
    filter(is.na(target))

set.seed(2019)

holdout_ids <- test_data %>%
    filter(!is.na(target)) %>%
    sample_frac(.2) %>%
    pull(key)

train <- test_data %>%
    filter(!is.na(target), !key %in% holdout_ids)

holdout <- test_data %>%
    filter(!is.na(target), key %in% holdout_ids)

```
## Exploring predictors

Start with age

```{r}

train %>% 
    ggplot(aes(birth_year)) +
        geom_histogram(binwidth = 2)

```

Mostly boomers. We should convert it to an age to make it slightly more interpretable. 

```{r}

train  <- train %>% 
    mutate(age = year(as.period(interval(ymd(paste0(birth_year, "0101")), today()))))

train %>%
    count(age, sort = TRUE)
```
### Categorical variables

```{r}

train %>% 
    select_if(is.character) %>%
    lapply(., table, useNA = "always")
    

```
A small amount of missingness we'll have to deal with. Mostly white, college educated, but a pretty even split between Democrats and Repbulicans. I wonder if missing is true missing or if that means independent. Is there any correlation between missing variables?

```{r}

train %>% 
    filter(is.na(party)) %>% 
    count(gender, race_4, edu)

```

I think for `race` and `edu` we should fill in missing with the mode and for party we can impute from the other variables. 

I wonder what that labels in `ideo` stand for?  

```{r}
train %>% 
    count(ideo, party) %>%
    mutate(pct = n / sum(n)) %>% 
    select(-n) %>%
    spread(ideo, pct)

```
Looks like 1 is progressive, -1 is conservative. Check how the target relates to party and ideology. 

```{r}
train %>%
    count(party, target) %>%
    spread(target, n)
```
1 is support for the policy (which restricts access to reproductive rights), 0 is oppose.

Let's look at how categorical variables relate to the target. 

```{r}

var_counts <- function(predictor) {

    pred <- enquo(predictor)

    train %>%
        select(!!pred, target) %>%
        count(target) %>%
        mutate(pct = n /  sum(n))
    
}


var_counts(gender)    
```



---
title: "D&T Hiring Test"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, eval = FALSE)

library(tidyverse)


voteshare <- readr::read_csv("data/voteshare.csv")
candidate <- readr::read_csv("data/candidate.csv")

```

## Task 1: SQL

```{python}

import pandas
from sqlalchemy import create_engine

engine = create_engine('sqlite://', echo=False)
conn = engine.raw_connection()

voteshare = pandas.read_csv("data/voteshare.csv")

candidate = pandas.read_csv("data/candidate.csv")
                
voteshare.to_sql('voteshare', conn, if_exists='replace', index=False)
candidate.to_sql("candidate", conn, if_exists='replace', index=False)


```

**Question 1: Produce the rows with the five highest win probability.**

```{python}

q1 = pandas.read_sql_query("SELECT * FROM voteshare ORDER BY win_probability DESC, voteshare DESC LIMIT 5", 
                           conn)

q1

```

```
SELECT * 

FROM voteshare 

ORDER BY win_probability DESC, voteshare DESC 

LIMIT 5

```

**Question 2: How many unique forecast dates are included in this data set? What is the earliest forecast? Latest forecast?**

```{python}

q2a = pandas.read_sql_query('''SELECT count(DISTINCT forecastdate) as unique_dates
                               FROM voteshare''', conn)
                  
q2a

```

```

SELECT count(DISTINCT forecastdate) as unique_dates

FROM voteshare
                               
```

```{python}

q2b = pandas.read_sql_query('''SELECT *
                  from (SELECT forecastdate 
                      from voteshare 
                      ORDER BY forecastdate
                      LIMIT 1) as first_date
                  
                  UNION 
                  
                  SELECT *
                  from (SELECT forecastdate 
                        from voteshare 
                        ORDER BY forecastdate DESC
                        LIMIT 1) as last_date''', conn)
                  
q2b

```

```
SELECT *

FROM (SELECT forecastdate 
      FROM voteshare 
      ORDER BY forecastdate
      LIMIT 1) as first_date
                  
UNION 
                  
SELECT *

FROM (SELECT forecastdate 
      FROM voteshare 
      ORDER BY forecastdate DESC
      LIMIT 1) as last_date

```

**Question 3: What was the average win probability for the November 6th forecast? Just for Democrats? Just for Republicans?**


```{python}


q3 = pandas.read_sql_query('''
SELECT 'all' as forecast_type,
      AVG(win_probability) as avg_win_prob
FROM voteshare
WHERE forecastdate = '2018-11-06'

UNION 

SELECT 'Republican' as forecast_type,
      AVG(win_probability) as avg_win_prob
FROM voteshare
WHERE forecastdate = '2018-11-06'
  AND party = 'R'

UNION 

SELECT 'Democrat' as forecast_type,
      AVG(win_probability) as avg_win_prob
FROM voteshare
WHERE forecastdate = '2018-11-06'
  AND party = 'D'
''', conn
)

q3

```


```
SELECT 'all' as forecast_type,
      AVG(win_probability) as avg_win_prob

FROM voteshare

WHERE forecastdate = '2018-11-06'

UNION 

SELECT 'Republican' as forecast_type,
        AVG(win_probability) as avg_win_prob

FROM voteshare

WHERE forecastdate = '2018-11-06'
  AND party = 'R'

UNION 

SELECT 'Democrat' as forecast_type,
        AVG(win_probability) as avg_win_prob
        
FROM voteshare

WHERE forecastdate = '2018-11-06'
  AND party = 'D'

```

**Question 4: What is the average win probability for the November 6th forecast for incumbents vs non-incumbents? This will require a join to the candidates table.**

```{python}


q4 = pandas.read_sql_query('''

SELECT AVG(voteshare.win_probability)

from voteshare
inner join candidate on voteshare.state = candidate.state 
  AND voteshare.party = candidate.party
  AND voteshare.district = candidate.district

WHERE candidate.incumbent = 't'
AND voteshare.forecastdate = '2018-11-06'


''', conn
)

q4

```

```

SELECT AVG(voteshare.win_probability)

FROM voteshare
INNER JOIN candidate on voteshare.state = candidate.state 
  AND voteshare.party = candidate.party
  AND voteshare.district = candidate.district

WHERE candidate.incumbent = 't'
AND voteshare.forecastdate = '2018-11-06'

```

## Task 2: Explanatory Email

**Question 1: Volunteers were told that they would be speaking with pro-choice voters, or in other words, they would be speaking with voters that were modeled to be pro-choice. One volunteer remarked that she came across a number of voters who were not in favor of reproductive rights. Write a sample email that field organizers can use to help explain why this might happen when using model scores.**

There's a quote in statistics that says "All models are wrong but some are useful." We can never perfectly predict someones beliefs, and we shouldn't try to. 

The type of model used to create these scores is called a classification model. The output of a classifcation model is really just a probability, in this case the probability that someone will be pro-choice. 

Whenever making decisions from a model, you have to set a reasonable cutoff. The cutoff 

## Task 4: Dashboarding

I created a Shiny application that can be accessed [here](https://jtcies.shinyapps.io/tmc-dashboard).

When creating this dashoard, I began by thinking about the decisions that staff using it might be looking for information about. I built the dashboard around the following questions:

- What has been the imapct of my investment in specific localities?
- What is the level of uncertainty around current predictions?
- What are the localities where a resource investment might have a substantial impact?

The dashboard has three main charts. Each of the charts can be filtered by the inputs on the left-hand side. 
- Party turnout: 
- State:
- District:
- Date:
- Number of close races to show: 

### Next steps

- incorporate candidate data (merging did not work)
- incoporate more information about the district (size, demographics)